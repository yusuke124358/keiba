name: scientist_v2_holdout

on:
  workflow_dispatch:
    inputs:
      campaign_id:
        description: Campaign ID (config/scientist_campaigns/<id>.yml)
        required: true
        default: camp_20260207
      shard:
        description: Shard in i/n form (e.g. 0/2)
        required: true
        default: "0/2"
      max_jobs:
        description: Max seeds to process (per run)
        required: true
        default: "5"

concurrency:
  group: scientist-v2-${{ github.event.inputs.campaign_id }}-${{ github.event.inputs.shard }}
  cancel-in-progress: false

jobs:
  holdout:
    runs-on: self-hosted
    # Default is 360 minutes; v2 runs can exceed that when eval is slow.
    timeout-minutes: 720
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false
      - name: Preflight
        shell: cmd
        run: powershell -ExecutionPolicy Bypass -File scripts\agent\preflight.ps1
      - name: Configure Codex
        shell: cmd
        run: powershell -ExecutionPolicy Bypass -Command "New-Item -ItemType Directory -Force -Path \"$env:USERPROFILE\\.codex\" | Out-Null; Copy-Item -Path .github/runner/codex.config.toml -Destination \"$env:USERPROFILE\\.codex\\config.toml\" -Force"
      - name: Configure Git Remote (push token)
        shell: cmd
        env:
          AUTO_FIX_PUSH_TOKEN: ${{ secrets.AUTO_FIX_PUSH_TOKEN }}
        run: >
          powershell -ExecutionPolicy Bypass -Command "if (-not $env:AUTO_FIX_PUSH_TOKEN) { throw 'AUTO_FIX_PUSH_TOKEN missing' }; git remote set-url origin https://x-access-token:$env:AUTO_FIX_PUSH_TOKEN@github.com/${{ github.repository }}.git"
      - name: Configure Paths
        shell: cmd
        run: >
          powershell -ExecutionPolicy Bypass -Command "$shard='${{ inputs.shard }}'; $safeShard=$shard.Replace('/','-'); $idx=$shard.Split('/')[0]; $runner=$env:RUNNER_NAME; if (-not $runner) { $runner='runner' }; $state=\"C:\\keiba_scientist\\state_repo\\$runner\"; $art=\"C:\\keiba_scientist\\artifacts\\$runner\\shard-$idx\"; New-Item -ItemType Directory -Force -Path $state,$art | Out-Null; \"KEIBA_STATE_REPO_DIR=$state\" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8; \"KEIBA_ARTIFACT_DIR=$art\" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8; \"SAFE_SHARD=$safeShard\" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8"
      - name: Install deps (venv)
        shell: cmd
        run: |
          where py >nul 2>nul
          if %ERRORLEVEL%==0 (
            py -3.12 -m venv py64_analysis\\.venv
          ) else (
            python -m venv py64_analysis\\.venv
          )
          py64_analysis\\.venv\\Scripts\\python.exe -m pip install -U pip
          py64_analysis\\.venv\\Scripts\\python.exe -m pip install -e "py64_analysis[dev]"
      - name: Run Scientist V2 (Holdout)
        shell: cmd
        run: >
          py64_analysis\\.venv\\Scripts\\python.exe scripts\\agent\\scientist_v2.py --campaign ${{ inputs.campaign_id }} --stage holdout --shard ${{ inputs.shard }} --max-jobs ${{ inputs.max_jobs }}
      - name: Stage artifacts (workspace)
        if: always()
        shell: cmd
        run: >
          powershell -ExecutionPolicy Bypass -Command "$campaign='${{ inputs.campaign_id }}'; $src=Join-Path $env:KEIBA_ARTIFACT_DIR $campaign; $dest=Join-Path $env:GITHUB_WORKSPACE 'artifact_upload'; Remove-Item -Recurse -Force $dest -ErrorAction SilentlyContinue; New-Item -ItemType Directory -Force -Path $dest | Out-Null; $destCamp=Join-Path $dest $campaign; New-Item -ItemType Directory -Force -Path $destCamp | Out-Null; if (Test-Path (Join-Path $src 'experiments')) { Copy-Item -Recurse -Force (Join-Path $src 'experiments') $destCamp }; if (Test-Path (Join-Path $src 'plans')) { Copy-Item -Recurse -Force (Join-Path $src 'plans') $destCamp }; Copy-Item -Force 'AGENTS.md' (Join-Path $dest 'AGENTS.md') -ErrorAction SilentlyContinue"
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scientist-v2-${{ github.event.inputs.campaign_id }}-holdout-${{ env.SAFE_SHARD }}-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            artifact_upload/**
          if-no-files-found: warn
