name: auto-fix-loop

on:
  issue_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  workflow_run:
    workflows: ["ci"]
    types: [completed]
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

concurrency:
  group: auto-fix-${{ github.event.pull_request.number || github.event.issue.number || github.run_id }}
  cancel-in-progress: true

jobs:
  auto_fix:
    if: >
      (github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'failure')
      && (github.event_name != 'issue_comment' || github.event.issue.pull_request != null)
    runs-on: self-hosted
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - uses: actions/cache@v4
        with:
          path: artifacts/agent
          key: auto-fix-state-${{ github.run_id }}
          restore-keys: |
            auto-fix-state-

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m venv py64_analysis/.venv
          py64_analysis/.venv/bin/python -m pip install -U pip
          py64_analysis/.venv/bin/python -m pip install -e "py64_analysis[dev]"
          py64_analysis/.venv/bin/python -m pip install pyyaml

      - name: Load config
        id: cfg
        env:
          CODEX_VERSION: ${{ vars.CODEX_VERSION }}
        run: |
          py64_analysis/.venv/bin/python - <<'PY'
          import os
          from pathlib import Path
          import yaml

          data = yaml.safe_load(Path("config/auto_fix.yml").read_text(encoding="utf-8")) or {}
          labels = data.get("labels") or {}
          codex_version = os.environ.get("CODEX_VERSION") or data.get("codex_version", "0.80.0")
          auto_fix = labels.get("auto_fix", "auto-fix")
          needs_human = labels.get("needs_human", "needs-human")
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
              fh.write(f"codex_version={codex_version}\n")
              fh.write(f"auto_fix_label={auto_fix}\n")
              fh.write(f"needs_human_label={needs_human}\n")
          PY

      - name: Ensure labels
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh label create "${{ steps.cfg.outputs.auto_fix_label }}" --color "0E8A16" --description "Auto-fix eligible PR" --force || true
          gh label create "${{ steps.cfg.outputs.needs_human_label }}" --color "B60205" --description "Needs human decision" --force || true

      - name: Resolve PR number
        id: pr
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          event = json.loads(Path(os.environ["GITHUB_EVENT_PATH"]).read_text(encoding="utf-8"))
          pr_number = ""
          if "pull_request" in event and event["pull_request"]:
            pr_number = str(event["pull_request"].get("number", ""))
          elif "issue" in event and event["issue"] and event["issue"].get("pull_request"):
            pr_number = str(event["issue"].get("number", ""))
          elif "workflow_run" in event:
            prs = event["workflow_run"].get("pull_requests") or []
            if prs:
              pr_number = str(prs[0].get("number", ""))
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
            fh.write(f"pr_number={pr_number}\n")
          PY

      - name: Collect signals
        id: collect
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -n "${{ steps.pr.outputs.pr_number }}" ]; then
            py64_analysis/.venv/bin/python scripts/agent/review_loop.py --stage collect --pr "${{ steps.pr.outputs.pr_number }}"
          else
            py64_analysis/.venv/bin/python scripts/agent/review_loop.py --stage collect
          fi
          py64_analysis/.venv/bin/python - <<'PY'
          import json
          import os
          from pathlib import Path
          meta_path = Path("artifacts/agent/current_run.json")
          if not meta_path.exists():
              with open(Path(os.environ["GITHUB_OUTPUT"]), "a", encoding="utf-8") as fh:
                  fh.write("should_run=false\n")
              raise SystemExit(0)
          meta = json.loads(meta_path.read_text(encoding="utf-8"))
          with open(Path(os.environ["GITHUB_OUTPUT"]), "a", encoding="utf-8") as fh:
              fh.write(f"should_run={'true' if meta.get('should_run') else 'false'}\n")
              for key in ("run_dir", "reviewer_prompt", "manager_prompt", "fixer_prompt", "review_items", "manager_decision", "fixer_report"):
                  if key in meta:
                      fh.write(f"{key}={meta[key]}\n")
              fh.write(f"pr_number={meta.get('pr_number','')}\n")
          PY

      - name: Reviewer
        if: steps.collect.outputs.should_run == 'true'
        uses: openai/codex-action@v1
        with:
          prompt-file: ${{ steps.collect.outputs.reviewer_prompt }}
          output-file: ${{ steps.collect.outputs.review_items }}
          output-schema-file: schemas/agent/review_items.schema.json
          codex-version: ${{ steps.cfg.outputs.codex_version }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Normalize review items
        if: steps.collect.outputs.should_run == 'true'
        run: |
          py64_analysis/.venv/bin/python scripts/agent/review_loop.py --stage normalize --run-dir "${{ steps.collect.outputs.run_dir }}"

      - name: Manager
        if: steps.collect.outputs.should_run == 'true'
        uses: openai/codex-action@v1
        with:
          prompt-file: ${{ steps.collect.outputs.manager_prompt }}
          output-file: ${{ steps.collect.outputs.manager_decision }}
          output-schema-file: schemas/agent/manager_decision.schema.json
          codex-version: ${{ steps.cfg.outputs.codex_version }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Fixer
        if: steps.collect.outputs.should_run == 'true'
        uses: openai/codex-action@v1
        with:
          prompt-file: ${{ steps.collect.outputs.fixer_prompt }}
          output-file: ${{ steps.collect.outputs.fixer_report }}
          output-schema-file: schemas/agent/fixer_report.schema.json
          codex-version: ${{ steps.cfg.outputs.codex_version }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Finalize
        if: steps.collect.outputs.should_run == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          AUTO_FIX_PUSH_TOKEN: ${{ secrets.AUTO_FIX_PUSH_TOKEN }}
        run: |
          py64_analysis/.venv/bin/python scripts/agent/review_loop.py --stage finalize --run-dir "${{ steps.collect.outputs.run_dir }}"
